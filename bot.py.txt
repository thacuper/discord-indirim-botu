import discord
import requests
import asyncio
from datetime import datetime, time, timedelta

TOKEN = "MTQwNDI2MzQ2NjE4NDk5OTA0Mw.GDt7UW.3lgrvYkBoU-M8cOkzYuPUivlUG4ttdLS5PXw30"
KANAL_ID = 123456789012345678

intents = discord.Intents.default()
client = discord.Client(intents=intents)

async def steam_ve_epic_indirimleri():
    kanal = client.get_channel(KANAL_ID)
    if kanal is None:
        print("âš  Kanal bulunamadÄ±! ID yanlÄ±ÅŸ olabilir veya botun eriÅŸimi yok.")
        return

    mesajlar = []

    # --- STEAM Ä°NDÄ°RÄ°MLERÄ° ---
    try:
        steam_url = "https://store.steampowered.com/api/featuredcategories"
        steam_veri = requests.get(steam_url).json()
        for oyun in steam_veri.get("specials", {}).get("items", []):
            if oyun.get("discount_percent", 0) >= 40:
                mesajlar.append(
                    f"**[STEAM]** {oyun['name']} - %{oyun['discount_percent']} indirim\n"
                    f"Fiyat: {oyun['final_price']/100:.2f} TL\n{oyun['url']}"
                )
    except Exception as e:
        mesajlar.append(f"Steam verisi alÄ±namadÄ±: {e}")

    # --- EPIC GAMES Ä°NDÄ°RÄ°MLERÄ° ---
    try:
        epic_url = "https://store-site-backend-static.ak.epicgames.com/freeGamesPromotions"
        epic_veri = requests.get(epic_url).json()

        for oyun in epic_veri.get("data", {}).get("Catalog", {}).get("searchStore", {}).get("elements", []):
            price_info = oyun.get("price", {}).get("totalPrice", {})
            discount_pct = price_info.get("discountPercentage", 0)
            if discount_pct >= 40:
                url = f"https://store.epicgames.com/p/{oyun['catalogNs']['mappings'][0]['pageSlug']}"
                mesajlar.append(
                    f"**[EPIC]** {oyun['title']} - %{discount_pct} indirim\n"
                    f"Fiyat: {price_info.get('fmtPrice', {}).get('discountPrice', 'Bilinmiyor')}\n{url}"
                )
    except Exception as e:
        mesajlar.append(f"Epic verisi alÄ±namadÄ±: {e}")

    # Mesaj gÃ¶nder
    if not mesajlar:
        await kanal.send("Åu an %40 ve Ã¼stÃ¼ indirim bulunamadÄ±.")
    else:
        await kanal.send("\n\n".join(mesajlar))

async def gunde_bir_gonder():
    await client.wait_until_ready()
    kanal = client.get_channel(KANAL_ID)

    while not client.is_closed():
        now = datetime.now()
        hedef_saat = time(12, 0)  # Saat 12:00
        hedef_zaman = datetime.combine(now.date(), hedef_saat)

        if now > hedef_zaman:
            hedef_zaman += timedelta(days=1)

        bekleme_suresi = (hedef_zaman - now).total_seconds()
        print(f"Sonraki gÃ¶nderim {hedef_zaman} - {bekleme_suresi/60:.1f} dakika kaldÄ±")
        await asyncio.sleep(bekleme_suresi)

        await steam_ve_epic_indirimleri()

@client.event
async def on_ready():
    print(f"{client.user} olarak giriÅŸ yapÄ±ldÄ±!")
    kanal = client.get_channel(KANAL_ID)
    if kanal:
        await kanal.send("Bot Ã§alÄ±ÅŸmaya baÅŸladÄ±! ğŸ® Her gÃ¼n 12:00'de indirimler gelecek.")
    client.loop.create_task(gunde_bir_gonder())

client.run(TOKEN)